---
title: "Headache Severity Treatment Analysis"
author: "Ally Tirendi"
date: "10/17/2025"
output:
  html_document:
    df_print: paged
    toc: true
    number_sections: false
    toc_depth: '3'
    code_folding: show
---

```{r,echo=FALSE,message=FALSE,warning=FALSE}
# this is a set-up chunk
# DON'T CHANGE THESE SETTINGS--I'VE SET THEM UP TO MAKE THINGS RUN SMOOTHLY 
require(knitr)
try(knitr::opts_chunk$set(echo = TRUE, error = TRUE, 
                      root.dir = rprojroot::find_rstudio_root_file()))

try(knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()))


```

# Clean Data

```{r}
# load the data

library(tidyverse)

load("~/Desktop/school/BIOST 2141/Data/acupuncture_data_reduced-1.RData", verbose = T)
ac = data


# two new variables (change in severity and factor for treatment group)

ac = ac %>%
  mutate(delta_base = pk2 - pk1, 
         group_f = factor(group, levels = c(0,1),
                          labels = c("control", "treatment")))

ac
```

#  Control and Treatment Analysis 

## Descriptives

```{r}
# numerical summary for change in severity
ac %>% 
  drop_na(delta_base) %>%
  summarise(n = n(),
            mean = mean(delta_base),
            median = median(delta_base),
            min = min(delta_base),
            max = max(delta_base),
            q25 = quantile(delta_base,.25),
            q75 = quantile(delta_base,.75),
            var = var(delta_base),
            sd = sd(delta_base)) %>%
  mutate(IQR = q75-q25,
         range = max - min)

```

```{r}
#visualizations of change in severity
ac %>%
  drop_na(delta_base) %>%
  ggplot(aes(x = delta_base)) +
  geom_histogram(color = "black", fill = "pink", bins = 150) +
  theme_bw() +
  labs(title = "Distribution of Change in Headache Severity",
       x = "Difference between 3 Months and Baseline")

ac %>%
  drop_na(delta_base) %>%
  ggplot(aes(y = delta_base)) +
  geom_boxplot(fill = "pink", color = "black" ) +
  theme_bw() +
  labs(title = "Distribution of Change in Headache Severity (2)",
       y = "Difference between 3 Months and Baseline")


```

From the histogram we can see the distribution is roughly normally distributed. Also, from the boxplot, we can see the distribution has long tails, with possible outliers. Due to the possible outliers in the distribution, the median and IQR would be the best representation of the center and spread respectively. The median was -4, meaning there was a decrease in four headaches between 3 months and baseline, and the IQR was ~10.4, meaning 50% of the data is within a range of ~10.4 headaches. Specifically, the middle 50% saw a decrease of ~9 headaches and an increase of ~1 headache between 3 months and baseline.

## Paired t test

```{r}
# paired t-test with function

#CLT conditions: n>30
#assume random sample
#dependent data (comparing to same person)

ac %>%
  ggplot(aes(sample = delta_base)) +
  theme_bw() +
  stat_qq() +
  stat_qq_line() +
  labs(x = "Theoretical Normal Quantiles",
       y = "Observed Quantiles (change in headache severity)")

acna = ac %>% drop_na(delta_base)

#check sample size

length(acna$delta_base)
length

# n = 326 so we can apply CLT and perform paired t-test

t.test(x = acna$pk2, y = acna$pk1, conf.level = 0.99, paired = T)


```

The conditions for a paired t-test have been met as we have a random sample from the population, our sets of observations (between baseline and 3 months) are dependent, and n(number of pairs) > 30 (n = 326). Furthermore, from the QQ plot we can see that the data is not normally distributed and is slightly left skewed, but since we have n > 30 we can continue with the paired t-test. The null hypothesis is "the mean change in headache severity between baseline and 3 months is equal to zero." Our alternative hypothesis is "the mean change in headache severity between baseline and 3 months is not zero." The value of our test statistic, both from the test and by hand, is ~(-7.26). So, our sample mean difference is 7.26 standard errors away from the null (mean change = 0). Moreover, the p-value of the test is ~2.88e-12 suggesting that our p-value is much smaller than our significance level of 0.01. We are 99% confident that the true population mean change is between ~(-6.40) and ~(-3.03). Overall, looking at the test statistic, p-value, and confidence interval, we have sufficient evidence to reject the null hypothesis. Since the test statistic is large, the p-value is much smaller than 0.01, and our null value (0) is not in the 99% confidence interval, we should reject the null hypothesis. So, there is strong evidence that the population experienced an average decrease in headache severity from baseline to 3 months.

## Signed rank test

```{r}
# wilcoxon test

wilcox.test(x = acna$pk2, y = acna$pk1, paired = T, mu = 0, correct = F)

```

The conditions for a Wilcoxon Signed Rank test have been met as we have a random sample from the population, and our distribution of the change in headache severity is roughly symmetric. The null hypothesis is the median change of headache severity between 3 months and baseline is equal to zero, while our alternative hypothesis is the median change of headache severity between 3 months and baseline is not zero. The p-value from the test was ~5.798e-15 which is much smaller than our significance level of 0.01. From this information, we have sufficient evidence to reject the null hypothesis and conclude that the median change of headache severity between 3 months and baseline is not zero. In conclusion, there is strong evidence the population experienced a decrease in headache severity from baseline to 3 months. 

## Summary of part 1 

Overall, we have sufficient evidence to claim the population (control and acupuncture treatment combined) experienced a decrease in headache severity from baseline to 3 months. From our parametric paired t-test we can say there was strong evidence at a 99% confidence interval that the population had, on average, 3-6 less headaches over the 3 months. Between the parametric and nonparametric inference procedure, the results did not change and both tests concluded that we had sufficient evidence to reject the null hypothesis.

# Control vs Treatment Analysis  

## Descriptives


```{r}
# numerical summary for change in severity by treatment group

ac %>% drop_na(delta_base) %>%
  group_by(group_f) %>%
  summarise(n = n(),
            mean_change = mean(delta_base),
            median_change = median(delta_base),
            sd_change = sd(delta_base)) %>%
  mutate(t = mean_change / (sd_change / sqrt(n)))


#visualizations
ac %>%
  drop_na(delta_base) %>%
  ggplot(aes(x = group_f, y = delta_base, color = group_f)) +
  geom_boxplot() +
  theme_bw() +
  geom_jitter(aes(color = group_f), alpha = 0.5, size = 0.75, width = 0.25) +
  labs(title = "Change In Headache Severity for Each Group",
       x = NULL,
       y = "Change from Baseline to 3 Months") +
  theme(legend.position = "none")

ac %>%
  drop_na(delta_base) %>%
  ggplot(aes(x = delta_base, fill = group_f)) +
  geom_histogram(color = "black", bins = 30) +
  facet_wrap(. ~ group_f, nrow = 2) +
  scale_fill_manual(values = c("control" = "pink", "treatment" = "lightblue")) +
  theme_classic() +
  labs(x = "Change in Headache Severity")

  
```


```{r}
# use the new factor variable you created to split by group
ac = ac %>%
  mutate(sex_f = factor(sex, levels = c(0,1),
                        labels = c("male", "female")))

#numerical summary of age by treatment group
ac %>%
  drop_na(age) %>%
  group_by(group_f) %>%
  summarise(mean = mean(age),
            median = median(age),
            min = min(age),
            max = max(age),
            q25 = quantile(age,.25),
            q75 = quantile(age,.75),
            var = var(age),
            sd = sd(age)) %>%
  mutate(IQR = q75-q25,
         range = max - min)

#visualization of age by treatment group
ac %>%
  drop_na(age) %>%
  ggplot(aes(y = age, x = group_f)) +
  geom_boxplot() +
  geom_jitter(aes(color = group_f), alpha = 0.5) +
  labs(x = "Treatment Group") +
  theme_bw() + 
  theme(legend.position = "none")

#numerical summary of sex by treatment group
ac %>% 
  group_by(group_f, sex_f) %>%
  summarise(f = n()) %>%
  mutate(phat = round(f / sum(f), digits = 3))

#visualization of sex by treatment group
ac %>%
  ggplot(aes(x = group_f, fill = sex_f)) +
  geom_bar() +
  labs(x = "Treatment Group", fill = "Sex") +
  theme_bw()
```


When comparing the change in headache severity for the acupuncture treatment and control groups we can see from the histogram, the control group is roughly normally distributed while the treatment group is bimodal.From the boxplot, we can see the distributions are roughly similar in their spreads. The treatment group seems to have a smaller IQR than the control group. Furthermore, comparing their centers, the control group has a mean change of ~(-2.75), while the treatment group has a mean change of ~(-6.45). This means both groups experienced an average decrease in headache severity between 3 months and baseline, but the treatment group saw a much larger average decrease in headache severity compared to the control. When comparing the ages of the control and treatment groups, we can see that the mean, median, max, and minimum are almost exactly the same between groups. The only noticeable difference is the IQR and variance, with the control having a slightly larger variability. Furthermore, when comparing the sex of the treatment and control groups, we see there is a significantly higher proportion of females than males present in each group. The study design might have contributed to these results as the randomized controlled trial worked in its efforts for randomization of age. However, the difference in sex might be due to the fact females experience more headaches than males, and even when trying to control for differences, the study design will naturally reflect a higher proportion of females. This will further impact the conclusions we're able to draw in the next section as we can only generalize the results to females as they are the majority of our population. Therefore, it is not suitable to generalize these findings to males.

## Two-sample t test

```{r}
# two sample t test with function

#CLT conditions
#assume random sample
#assume independent data

xtabs(~ group_f, data = ac)

# n_trt = 205 and n_crtl = 196 so we can apply CLT

# t test with alpha = 0.05
t.test(delta_base ~ group_f, data = ac, conf.level = 0.95, var.equal = FALSE)


```

The conditions for a two-sample t-test have been met as we have random samples from two populations, two independent groups, n1 > 30 and n2 > 30. The null hypothesis states the difference in headache severity between the control and acupuncture treatment groups is zero. The alternative hypothesis states the difference in headache severity between the control and acupuncture groups is not equal to zero. The value of the test statistic from this sample was ~2.9 and the p-value of this sample was ~0.004. Furthermore, we are 95% confident the true population mean is between ~1.19 and ~6.22. Overall, since the p-value is less than our significance level of a = 0.05 and our null value (0) is not in our 95% confidence interval, we have sufficient evidence to reject the null hypothesis. In conclusion, we do have strong evidence to say the acupuncture treatment had an impact on the change of headache severity in the population. Using our other tests, we have sufficient evidence to say the acupuncture treatment decreased headache severity in the population.


## Wilcoxon rank sum test


```{r}
# wilcoxon test
wilcox.test(delta_base ~ group_f, data = ac, alternative = "two.sided", conf.level = 0.95, correct = F)

```

The conditions for a Wilcoxon rank sum test have been met as we have a random samples from two populations, two independent groups, and population distributions should have the same shape. The null hypothesis states the population median of the change in headache severity from the control group is equal to the population median of the change in headache severity of the treatment group. While the alternative hypothesis states that the population median change in headache severity of the control group does not equal the population median change in headache severity of the treatment group. The p-value is ~0.001 which is smaller than our significance level of 0.05. Overall, we have sufficient evidence to reject the null hypothesis. In conclusion, we have evidence to suggest the treatment group experienced a different change in headache severity over the 3 months compared to the control group.


## Summary of part 2

Summary: Overall, the acupuncture treatment group saw a larger decrease in headache severity compared to the control group. The p-value from the two-sample t-test was 0.003 which was much smaller than our significance level of 0.05, and our test statistic of ~2.4 was not included in the 95% confidence interval between ~ 2.7 and ~ 6.4. With this information, and the results of the rank sum test (p-value: 0.001 < 0.05), we have sufficient evidence to reject the null hypothesis and conclude the change in headache severity was different between the two groups. While the parametric t-test is sensitive to outliers, it still lead us to reject the null hypothesis, and our non-parametric rank sum test, which is less sensitive to outliers, supported this conclusion.

# Session Information

```{r}
sessionInfo()
```
